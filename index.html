<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JEE Performance & Planner | Minimalist</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        /* BASE & RESET */
        :root {
            --color-dark-bg: #0f0f0f;
            --color-dark-card: #1c1c1c;
            --color-dark-text: #f0f0f0;
            --color-dark-subtext: #999;
            --color-dark-border: #444;
            --color-dark-primary: #f0f0f0;
            --color-dark-secondary: #333;

            --color-light-bg: #f7f7f7;
            --color-light-card: #ffffff;
            --color-light-text: #1a1a1a;
            --color-light-subtext: #666;
            --color-light-border: #ddd;
            --color-light-primary: #1a1a1a;
            --color-light-secondary: #f0f0f0;
            
            --transition-speed: 0.3s;
            --pulse-speed: 2s;
            --font-mono: 'Menlo', 'Consolas', 'Monaco', monospace;
            --font-sans: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--color-dark-bg);
            min-height: 100vh;
            padding: 30px 15px;
            color: var(--color-dark-text);
            transition: background var(--transition-speed) ease, color var(--transition-speed) ease;
        }

        body.light-mode {
            background: var(--color-light-bg);
            color: var(--color-light-text);
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
        }
        
        /* CARD STYLES & ANIMATION */
        .card {
            background: var(--color-dark-card);
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.4);
            border: 1px solid var(--color-dark-border);
            transition: all var(--transition-speed) ease, transform 0.2s;
            opacity: 0; /* For fade-in animation */
            transform: translateY(20px); /* For slide-up animation */
        }
        
        body.light-mode .card {
            background: var(--color-light-card);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            border: 1px solid var(--color-light-border);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.5);
        }
        
        body.light-mode .card:hover {
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }
        
        /* TYPOGRAPHY */
        h1 { font-size: 2.2rem; margin-bottom: 5px; letter-spacing: -0.5px; color: var(--color-dark-primary); }
        body.light-mode h1 { color: var(--color-light-primary); }
        h2 { font-size: 1.5rem; margin-bottom: 20px; text-transform: uppercase; letter-spacing: 1px; color: var(--color-dark-primary); border-bottom: 1px solid var(--color-dark-border); padding-bottom: 10px; }
        body.light-mode h2 { color: var(--color-light-primary); border-bottom: 1px solid var(--color-light-border); }
        h3 { font-size: 1.1rem; color: var(--color-dark-text); }
        body.light-mode h3 { color: var(--color-light-text); }
        .subtitle { color: var(--color-dark-subtext); margin-bottom: 20px; font-size: 0.95rem; }
        body.light-mode .subtitle { color: var(--color-light-subtext); }

        /* STATS GRID & FORMS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .stat-card {
            text-align: center;
            padding: 20px;
            border: 1px solid var(--color-dark-border);
            border-radius: 6px;
            transition: all var(--transition-speed) ease;
        }

        body.light-mode .stat-card {
            border: 1px solid var(--color-light-border);
        }

        .stat-card:hover {
            background: var(--color-dark-secondary);
        }
        body.light-mode .stat-card:hover {
            background: var(--color-light-secondary);
        }
        
        .stat-label { 
            font-size: 0.8rem; 
            color: var(--color-dark-subtext); 
            text-transform: uppercase; 
            letter-spacing: 1px;
            margin-bottom: 5px;
        }
        body.light-mode .stat-label { color: var(--color-light-subtext); }
        
        .stat-value { 
            font-size: 1.8rem; 
            font-weight: 700; 
            color: var(--color-dark-text);
            transition: color var(--transition-speed) ease;
        }
        body.light-mode .stat-value { color: var(--color-light-text); }
        
        .stat-sub { 
            font-size: 0.85rem; 
            color: var(--color-dark-subtext);
        }
        body.light-mode .stat-sub { color: var(--color-light-subtext); }

        /* FORM ELEMENTS */
        label { color: var(--color-dark-subtext); font-size: 0.9rem; text-transform: uppercase; letter-spacing: 0.5px; display: block; margin-bottom: 5px; }
        body.light-mode label { color: var(--color-light-subtext); }

        input, textarea {
            padding: 10px; border: 1px solid var(--color-dark-border); border-radius: 4px; font-size: 1rem;
            background: var(--color-dark-bg); color: var(--color-dark-text); width: 100%; 
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        body.light-mode input, body.light-mode textarea {
            background: var(--color-light-card); color: var(--color-light-text); border: 1px solid var(--color-light-border);
        }
        
        input:focus, textarea:focus {
            border-color: var(--color-dark-text);
            outline: none;
            box-shadow: 0 0 0 1px var(--color-dark-text);
        }
        
        body.light-mode input:focus, body.light-mode textarea:focus {
            border-color: var(--color-light-text);
            box-shadow: 0 0 0 1px var(--color-light-text);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }
        
        /* BUTTONS & RIPPLE EFFECT */
        button { 
            padding: 10px 20px; border: none; border-radius: 4px; font-size: 0.9rem; font-weight: 600; cursor: pointer; 
            transition: all var(--transition-speed) ease; position: relative; overflow: hidden;
            text-transform: uppercase; letter-spacing: 1px;
        }

        .btn-primary { 
            background: var(--color-dark-primary); color: var(--color-dark-bg); width: 100%; margin-top: 10px;
        }
        .btn-primary:hover {
            background: #ccc;
        }

        body.light-mode .btn-primary { 
            background: var(--color-light-primary); color: var(--color-light-bg);
        }
        body.light-mode .btn-primary:hover {
            background: #444;
        }

        .btn-secondary { 
            background: var(--color-dark-secondary); color: var(--color-dark-text); padding: 8px 12px;
        }
        .btn-secondary:hover {
            background: var(--color-dark-border);
        }
        
        body.light-mode .btn-secondary { 
            background: var(--color-light-secondary); color: var(--color-light-text);
        }
        body.light-mode .btn-secondary:hover {
            background: var(--color-light-border);
        }

        .btn-delete { 
            background: #444; color: var(--color-dark-text); padding: 8px 16px; font-size: 0.85rem;
        }
        .btn-delete:hover {
            background: #666;
        }
        body.light-mode .btn-delete {
            background: #ccc; color: var(--color-light-text);
        }
        body.light-mode .btn-delete:hover {
            background: #aaa;
        }
        
        .button-group { display: flex; gap: 10px; margin-bottom: 15px; }

        /* RIPPLE EFFECT STYLES */
        .ripple {
            position: absolute;
            border-radius: 50%;
            transform: scale(0);
            animation: ripple-effect 0.6s linear;
            background-color: rgba(255, 255, 255, 0.4);
        }
        body.light-mode .ripple {
            background-color: rgba(0, 0, 0, 0.2);
        }
        @keyframes ripple-effect {
            to {
                transform: scale(4);
                opacity: 0;
            }
        }
        
        /* THEME TOGGLE */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--color-dark-secondary);
            border: 1px solid var(--color-dark-border);
            color: var(--color-dark-text);
            width: 40px; height: 40px; border-radius: 50%;
            font-size: 1.2rem; line-height: 1; z-index: 1000;
            padding: 0;
            text-transform: none;
            letter-spacing: normal;
        }
        body.light-mode .theme-toggle {
            background: var(--color-light-secondary);
            border: 1px solid var(--color-light-border);
            color: var(--color-light-text);
        }

        /* STOPWATCH SPECIFIC STYLES */
        @keyframes pulse-dark {
            0%, 100% { color: var(--color-dark-text); text-shadow: none; }
            50% { color: #fff; text-shadow: 0 0 10px rgba(255, 255, 255, 0.5); }
        }
        @keyframes pulse-light {
            0%, 100% { color: var(--color-light-text); text-shadow: none; }
            50% { color: #000; text-shadow: 0 0 10px rgba(0, 0, 0, 0.2); }
        }
        
        .stopwatch-display {
            font-family: var(--font-mono);
            font-size: 3rem;
            font-weight: 400;
            text-align: center;
            color: var(--color-dark-text);
            margin: 15px 0;
            padding: 10px 0;
            border-top: 1px dashed var(--color-dark-border);
            border-bottom: 1px dashed var(--color-dark-border);
            transition: all var(--transition-speed) ease;
        }
        
        body.light-mode .stopwatch-display {
            color: var(--color-light-text);
            border-top: 1px dashed var(--color-light-border);
            border-bottom: 1px dashed var(--color-light-border);
        }

        .stopwatch-display.running {
            animation: pulse-dark var(--pulse-speed) infinite;
        }
        body.light-mode .stopwatch-display.running {
            animation: pulse-light var(--pulse-speed) infinite;
        }

        .stopwatch-controls { display: flex; gap: 10px; justify-content: center; }
        .stopwatch-controls button { width: auto; margin: 0; }
        
        .start-btn-custom { background: #555 !important; }
        .stop-btn-custom { background: #888 !important; }
        body.light-mode .start-btn-custom { background: #bbb !important; }
        body.light-mode .stop-btn-custom { background: #888 !important; }

        /* CALENDAR LAYOUT & STYLES */
        .calendar-task-layout { display: flex; flex-direction: column; gap: 20px; padding-top: 10px; }
        .calendar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .calendar-header h3 { text-align: center; flex-grow: 1; font-weight: 600; }

        @media (min-width: 768px) {
            .calendar-task-layout { flex-direction: row; align-items: flex-start; }
            .calendar-wrapper { max-width: 320px; flex-shrink: 0; }
        }
        
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; text-align: center; font-size: 0.85rem; border: 1px solid var(--color-dark-border); border-radius: 4px; overflow: hidden;}
        body.light-mode .calendar-grid { border: 1px solid var(--color-light-border); }
        
        .calendar-day-name { font-weight: 600; color: var(--color-dark-text); padding: 8px 0; background: var(--color-dark-secondary); }
        body.light-mode .calendar-day-name { color: var(--color-light-text); background: var(--color-light-secondary); }

        .calendar-day { 
            padding: 10px 0; cursor: pointer; transition: background 0.1s ease, color 0.1s ease;
            position: relative; border: 1px solid var(--color-dark-border);
        }
        body.light-mode .calendar-day { border: 1px solid var(--color-light-border); }
        .calendar-day:hover { background: var(--color-dark-secondary); }
        body.light-mode .calendar-day:hover { background: var(--color-light-secondary); }
        
        .calendar-day.inactive { opacity: 0.3; pointer-events: none; border: 1px solid transparent !important; }
        .calendar-day.today { font-weight: 700; border: 2px solid var(--color-dark-text) !important; color: var(--color-dark-text) !important;}
        body.light-mode .calendar-day.today { border: 2px solid var(--color-light-text) !important; color: var(--color-light-text) !important;}
        
        .calendar-day.selected { 
            background: var(--color-dark-text) !important; 
            color: var(--color-dark-bg) !important;
            font-weight: 700;
        }
        body.light-mode .calendar-day.selected { 
            background: var(--color-light-text) !important; 
            color: var(--color-light-bg) !important;
        }
        
        .task-dot { position: absolute; bottom: 3px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: #999; border-radius: 50%; }
        
        .task-input-form button { width: auto; margin-left: auto; display: block; }
        
        .task-item, .log-entry {
            border-left: 4px solid var(--color-dark-subtext);
            padding: 10px 15px;
            background: var(--color-dark-secondary);
            border-radius: 4px;
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            opacity: 0;
            transform: translateX(-20px);
            transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94); /* Smooth slide-in */
        }
        body.light-mode .task-item, body.light-mode .log-entry {
            border-left: 4px solid var(--color-light-subtext);
            background: var(--color-light-secondary);
        }
        
        .log-entry { 
            flex-direction: column; 
            align-items: flex-start;
        }
        
        @media (min-width: 768px) {
            .log-entry { flex-direction: row; justify-content: space-between; align-items: center; }
        }
        
        .log-details { flex-grow: 1; margin-right: 15px; }
        .log-date-time strong { color: var(--color-dark-text); }
        body.light-mode .log-date-time strong { color: var(--color-light-text); }
        .log-actions-wrapper { display: flex; align-items: center; gap: 15px; margin-top: 10px; }
        
        @media (min-width: 768px) {
            .log-actions-wrapper { margin-top: 0; }
        }

        .log-hours { font-family: var(--font-mono); color: var(--color-dark-subtext); font-size: 0.9rem; }
        body.light-mode .log-hours { color: var(--color-light-subtext); }

        /* TABLE STYLES */
        #testTable {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.95rem;
            text-align: left;
            margin-top: 15px;
        }
        #testTable th, #testTable td {
            padding: 12px 15px;
            border-bottom: 1px solid var(--color-dark-border);
        }
        body.light-mode #testTable th, body.light-mode #testTable td {
            border-bottom: 1px solid var(--color-light-border);
        }
        #testTable th {
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-size: 0.8rem;
            color: var(--color-dark-subtext);
            font-weight: 600;
        }
        body.light-mode #testTable th { color: var(--color-light-subtext); }

        #testTable tbody tr:hover {
            background: var(--color-dark-secondary);
        }
        body.light-mode #testTable tbody tr:hover {
            background: var(--color-light-secondary);
        }

        /* BADGE COLORS (Monochromatic) */
        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 700;
            color: var(--color-dark-bg);
        }
        
        .badge-green { background-color: #aaa; }
        .badge-yellow { background-color: #888; }
        .badge-red { background-color: #666; }
        
        body.light-mode .badge { color: var(--color-light-bg); }
        body.light-mode .badge-green { background-color: #666; }
        body.light-mode .badge-yellow { background-color: #888; }
        body.light-mode .badge-red { background-color: #aaa; }


        /* FOOTER & ANIMATION */
        .footer { text-align: center; padding: 25px 0 10px 0; font-size: 0.8rem; color: var(--color-dark-subtext); transition: color var(--transition-speed) ease; }
        body.light-mode .footer { color: var(--color-light-subtext); }
        .footer a { 
            color: var(--color-dark-text); text-decoration: none; font-weight: 700; 
            position: relative;
            transition: color 0.3s ease;
        }
        body.light-mode .footer a { color: var(--color-light-text); }
        
        .footer a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 1px;
            display: block;
            margin-top: 2px;
            left: 0;
            background: var(--color-dark-text);
            transition: width var(--transition-speed) ease;
        }
        body.light-mode .footer a::after {
            background: var(--color-light-text);
        }
        
        .footer a:hover::after {
            width: 100%;
        }

        .hidden { display: none !important; }
        
        /* Chart specific color adjustments for dark mode */
        #trendChart {
            max-height: 400px;
        }
        
        /* Utility styles for the chart legends and axis titles */
        .chart-container {
            position: relative;
            height: 300px; /* Fixed height for better chart rendering */
        }
    </style>
</head>
<body>
    <button class="theme-toggle" onclick="toggleTheme()" id="themeToggle">üåô</button>
    
    <div class="container">
        
        <div class="card" data-idx="1">
            <h1>üéì JEE PERFORMANCE TRACKER</h1>
            <p class="subtitle">Minimalist interface for score tracking and study planning.</p>
            
            <div class="button-group">
                <button class="btn-primary" onclick="exportData()">üì• EXPORT DATA</button>
                <button class="btn-secondary" onclick="document.getElementById('importFile').click()">üì§ IMPORT DATA</button>
                <input type="file" id="importFile" accept=".json" onchange="importData(event)" style="display: none;">
            </div>
        </div>

        <div id="statsContainer" class="card hidden" data-idx="2"></div>
        
        <div class="card" data-idx="3">
            <h2>‚è±Ô∏è STUDY TIMER</h2>
            <div class="stopwatch-display" id="stopwatchDisplay">00:00:00</div>
            <div class="stopwatch-controls">
                <button class="btn-primary start-btn-custom" style="width: auto; margin: 0;" onclick="startStopwatch()" id="startStopBtn">Start</button>
                <button class="btn-secondary" style="width: auto; margin: 0;" onclick="resetStopwatch()">Reset</button>
            </div>
        </div>

        <div class="card" data-idx="4">
            <h2>üìä ADD TEST SCORE</h2>
            <div class="form-grid">
                <div class="form-group"><label>Test Date</label><input type="date" id="testDate" required></div>
                <div class="form-group"><label>Physics Marks</label><input type="number" id="physics" step="0.01" placeholder="0" required></div>
                <div class="form-group"><label>Chemistry Marks</label><input type="number" id="chemistry" step="0.01" placeholder="0" required></div>
                <div class="form-group"><label>Maths Marks</label><input type="number" id="maths" step="0.01" placeholder="0" required></div>
                <div class="form-group"><label>Total Marks</label><input type="number" id="totalMarks" value="300" required></div>
            </div>
            <button class="btn-primary" onclick="addTest()">ADD TEST RESULT</button>
        </div>

        <div class="card" id="chartCard" style="display: none;" data-idx="5">
            <h2>üìà PERFORMANCE TREND</h2>
            <div class="chart-container">
                <canvas id="trendChart"></canvas>
            </div>
        </div>

        <div class="card" id="tableCard" style="display: none;" data-idx="6">
            <h2>üìã TEST HISTORY</h2>
            <div style="overflow-x: auto;">
                <table id="testTable">
                    <thead>
                        <tr>
                            <th>Date</th><th>Physics</th><th>Chemistry</th><th>Maths</th><th>Total</th><th>Percentage</th><th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="testTableBody"></tbody>
                </table>
            </div>
        </div>

        <div class="card" data-idx="7">
            <h2>üìÖ STUDY PLANNER</h2>
            <div class="calendar-task-layout">
                <div class="calendar-wrapper">
                    <div class="calendar-header">
                        <button class="btn-secondary" onclick="changeMonth(-1)" title="Previous Month">&#9664;</button>
                        <h3 id="currentMonthYear"></h3>
                        <button class="btn-secondary" onclick="changeMonth(1)" title="Next Month">&#9654;</button>
                    </div>
                    <div class="calendar-grid" id="calendarGrid">
                        <div class="calendar-day-name">S</div><div class="calendar-day-name">M</div><div class="calendar-day-name">T</div><div class="calendar-day-name">W</div><div class="calendar-day-name">T</div><div class="calendar-day-name">F</div><div class="calendar-day-name">S</div>
                    </div>
                </div>

                <div class="task-section">
                    <h3 id="selectedDateTitle">SELECT A DATE</h3>
                    
                    <div class="form-group task-input-form" style="margin-top: 15px;">
                        <label for="taskInput">New Task/Work</label>
                        <textarea id="taskInput" placeholder="Enter your task here: e.g., Revise Kinematics" rows="2"></textarea>
                        <button class="btn-primary" onclick="addTask()">ADD TASK</button>
                    </div>

                    <div class="task-display">
                        <h4 style="margin-bottom: 10px; color: var(--color-dark-subtext);">PENDING TASKS:</h4>
                        <div id="taskList">
                            <p class="empty-state" style="padding: 10px; margin-top: 10px; border-top: none;">No tasks for this date.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card" data-idx="8">
            <h2 style="display: flex; justify-content: space-between;">
                ‚è≥ STUDY LOG 
                <span style="font-size: 1rem; color: var(--color-dark-text);" id="totalStudyHours">TOTAL LOGGED: 0.0 HRS</span>
            </h2>

            <div class="log-form-grid">
                <div class="form-group"><label>Date</label><input type="date" id="logDate" required></div>
                <div class="form-group"><label>Time Block</label><input type="text" id="logTime" placeholder="10:00 AM - 1:00 PM" required></div>
                <div class="form-group"><label>Activity Studied</label><input type="text" id="logActivity" placeholder="Physics numericals, Organic chemistry theory" required></div>
            </div>
            <button class="btn-primary" onclick="addStudyLog()">LOG SESSION</button>
            
            <h3 style="color: var(--color-dark-subtext); margin-top: 25px; margin-bottom: 10px;">RECENT SESSIONS</h3>
            <div id="studyLogList">
                <p class="empty-state" style="padding: 10px; border-top: none;">No study sessions logged yet.</p>
            </div>
        </div>
        <div class="footer">
            Designed with <span style="font-family: var(--font-mono); font-size: 1.1em; color: #fff;">|</span> and ‚òï by <a href="https://github.com/TNMY-3010" target="_blank">TNMY-3010</a>
        </div>
    </div>


    <script>
        // --- Core Data Arrays ---
        let tests = [];
        let tasks = {};
        let studyLogs = []; 
        let chart = null;

        // --- Planner State ---
        let currentMonth = new Date().getMonth();
        let currentYear = new Date().getFullYear();
        let selectedDate = new Date(); 
        
        // --- Stopwatch State ---
        let stopwatchInterval;
        let stopwatchRunning = false;
        let elapsedTime = 0; // Stored in milliseconds
        
        // --- Utility: Card Animations on Load ---
        function animateCards() {
            const cards = document.querySelectorAll('.card');
            cards.forEach((card, index) => {
                // Delay based on index for cascade effect
                setTimeout(() => {
                    card.style.transition = 'opacity 0.5s ease-out, transform 0.5s ease-out, box-shadow 0.2s, background 0.3s';
                    card.style.opacity = '1';
                    card.style.transform = 'translateY(0)';
                }, 50 * index);
            });
        }
        
        // --- Utility: Button Ripple Effect ---
        document.querySelectorAll('button').forEach(button => {
            button.addEventListener('click', function(e) {
                const rect = button.getBoundingClientRect();
                const size = Math.max(rect.width, rect.height);
                const x = e.clientX - rect.left - size / 2;
                const y = e.clientY - rect.top - size / 2;

                const ripple = document.createElement('span');
                ripple.classList.add('ripple');
                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;

                button.appendChild(ripple);
                setTimeout(() => ripple.remove(), 600);
            });
        });

        // --- INITIALIZATION ---
        window.onload = function() {
            loadTests();
            loadTasks(); 
            loadStudyLogs(); 
            loadTheme();
            updateUI();
            
            renderCalendar(); 
            selectDate(new Date().toDateString()); 
            
            animateCards(); // Start the card load animation
        };

        // --- Theme Functions ---
        function loadTheme() {
            const savedTheme = localStorage.getItem('jee-theme');
            const systemPrefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
            
            // Default to dark mode unless light mode is saved or system prefers light
            if (savedTheme === 'light' || (!savedTheme && !systemPrefersDark)) {
                document.body.classList.add('light-mode');
                document.getElementById('themeToggle').textContent = 'üåô';
            } else {
                document.getElementById('themeToggle').textContent = '‚òÄÔ∏è';
            }
            updateChart(); 
        }

        function toggleTheme() {
            const body = document.body;
            const toggle = document.getElementById('themeToggle');
            
            body.classList.toggle('light-mode');
            
            if (body.classList.contains('light-mode')) {
                toggle.textContent = 'üåô';
                localStorage.setItem('jee-theme', 'light');
            } else {
                toggle.textContent = '‚òÄÔ∏è';
                localStorage.setItem('jee-theme', 'dark');
            }
            updateChart(); 
        }

        // --- TEST TRACKER FUNCTIONS (Retained Logic) ---
        function loadTests() {
            const saved = localStorage.getItem('jee-tests');
            if (saved) {
                try { tests = JSON.parse(saved); } catch (e) { console.error('Error loading tests:', e); tests = []; }
            }
        }
        function saveTests() { localStorage.setItem('jee-tests', JSON.stringify(tests)); }
        
        function addTest() {
            const date = document.getElementById('testDate').value;
            const physics = parseFloat(document.getElementById('physics').value);
            const chemistry = parseFloat(document.getElementById('chemistry').value);
            const maths = parseFloat(document.getElementById('maths').value);
            const totalMarks = parseFloat(document.getElementById('totalMarks').value);

            if (!date || isNaN(physics) || isNaN(chemistry) || isNaN(maths) || isNaN(totalMarks) || totalMarks <= 0) {
                alert('Please fill in all fields with valid numbers.');
                return;
            }

            const total = physics + chemistry + maths;
            const percentage = (total / totalMarks) * 100;

            const test = { id: Date.now(), date, physics, chemistry, maths, total, totalMarks, percentage };
            tests.push(test);
            tests.sort((a, b) => new Date(a.date) - new Date(b.date));
            saveTests();

            document.getElementById('testDate').value = '';
            document.getElementById('physics').value = '';
            document.getElementById('chemistry').value = '';
            document.getElementById('maths').value = '';
            document.getElementById('totalMarks').value = '300';

            updateUI();
        }

        function deleteTest(id) {
            if (confirm('Are you sure you want to delete this test?')) {
                tests = tests.filter(t => t.id !== id);
                saveTests();
                updateUI();
            }
        }

        function updateUI() {
            updateStats();
            updateChart();
            updateTable();
            renderStudyLogs(); 
        }
        
        function updateStats() {
            const statsContainer = document.getElementById('statsContainer');
            if (tests.length === 0) {
                statsContainer.classList.add('hidden');
                return;
            }
            statsContainer.classList.remove('hidden');

            const latest = tests[tests.length - 1];
            const previous = tests.length > 1 ? tests[tests.length - 2] : null;
            const avgPercentage = tests.reduce((sum, t) => sum + t.percentage, 0) / tests.length;
            
            let progressChange = 0;
            if (previous) {
                const prevTotal = previous.total;
                const latestTotal = latest.total;
                if (prevTotal > 0) {
                    progressChange = ((latestTotal - prevTotal) / prevTotal) * 100;
                } else if (prevTotal === 0 && latestTotal > 0) {
                    progressChange = 100; 
                }
            }

            const nextTestDate = new Date(latest.date);
            nextTestDate.setDate(nextTestDate.getDate() + 21);
            const nextDateStr = nextTestDate.toLocaleDateString('en-GB');
            const progressSymbol = progressChange >= 0 ? '‚ñ≤' : '‚ñº';

            const statsHTML = `
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-label">Latest Score</div>
                        <div class="stat-value">${latest.total.toFixed(2)}/${latest.totalMarks}</div>
                        <div class="stat-sub">${latest.percentage.toFixed(2)}%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Progress</div>
                        <div class="stat-value" style="color: ${progressChange >= 0 ? '#888' : '#444'};">${progressSymbol} ${Math.abs(progressChange).toFixed(2)}%</div>
                        <div class="stat-sub">VS PREVIOUS TEST</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Average</div>
                        <div class="stat-value">${avgPercentage.toFixed(2)}%</div>
                        <div class="stat-sub">OVERALL PERFORMANCE</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Next Test Target</div>
                        <div class="stat-value" style="font-size: 1.5rem;">${nextDateStr}</div>
                        <div class="stat-sub">21-DAY CYCLE</div>
                    </div>
                </div>
            `;

            document.getElementById('statsContainer').innerHTML = statsHTML;
        }

        function updateChart() {
            const chartCard = document.getElementById('chartCard');
            if (tests.length === 0) { chartCard.style.display = 'none'; return; }
            chartCard.style.display = 'block';

            const ctx = document.getElementById('trendChart').getContext('2d');
            if (chart) { chart.destroy(); }

            const labels = tests.map(t => new Date(t.date).toLocaleDateString('en-GB', { day: '2-digit', month: 'short' }));
            const isLightMode = document.body.classList.contains('light-mode');
            const textColor = isLightMode ? '#1a1a1a' : '#f0f0f0';
            const gridColor = isLightMode ? 'rgba(0, 0, 0, 0.1)' : 'rgba(255, 255, 255, 0.1)';

            const dataSets = [
                { label: 'Total Score', data: tests.map(t => t.total), borderColor: textColor, backgroundColor: 'rgba(255, 255, 255, 0.2)', borderWidth: 3, tension: 0.4 },
                { label: 'Physics', data: tests.map(t => t.physics), borderColor: '#888', backgroundColor: 'transparent', borderWidth: 1, tension: 0.4 },
                { label: 'Chemistry', data: tests.map(t => t.chemistry), borderColor: '#666', backgroundColor: 'transparent', borderWidth: 1, tension: 0.4 },
                { label: 'Maths', data: tests.map(t => t.maths), borderColor: '#444', backgroundColor: 'transparent', borderWidth: 1, tension: 0.4 }
            ];
            
            // Adjust colors for light mode
            if (isLightMode) {
                dataSets[0].borderColor = textColor;
                dataSets[0].backgroundColor = 'rgba(0, 0, 0, 0.1)';
                dataSets[1].borderColor = '#666';
                dataSets[2].borderColor = '#888';
                dataSets[3].borderColor = '#aaa';
            }


            chart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: dataSets
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: true, position: 'top', labels: { color: textColor } } },
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Marks', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                        x: { title: { display: true, text: 'Test Date', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } }
                    }
                }
            });
        }

        function updateTable() {
            const tableCard = document.getElementById('tableCard');
            const tbody = document.getElementById('testTableBody');

            if (tests.length === 0) { tableCard.style.display = 'none'; tbody.innerHTML = ''; return; }
            tableCard.style.display = 'block';

            tbody.innerHTML = tests.map(test => {
                const badgeClass = test.percentage >= 75 ? 'badge-green' : test.percentage >= 50 ? 'badge-yellow' : 'badge-red';
                return `
                    <tr>
                        <td>${new Date(test.date).toLocaleDateString('en-GB')}</td>
                        <td style="color: ${document.body.classList.contains('light-mode') ? '#444' : '#888'}; font-weight: 600;">${test.physics.toFixed(2)}</td>
                        <td style="color: ${document.body.classList.contains('light-mode') ? '#666' : '#999'}; font-weight: 600;">${test.chemistry.toFixed(2)}</td>
                        <td style="color: ${document.body.classList.contains('light-mode') ? '#888' : '#aaa'}; font-weight: 600;">${test.maths.toFixed(2)}</td>
                        <td style="font-weight: bold; color: ${document.body.classList.contains('light-mode') ? '#1a1a1a' : '#f0f0f0'};">${test.total.toFixed(2)}/${test.totalMarks}</td>
                        <td><span class="badge ${badgeClass}">${test.percentage.toFixed(2)}%</span></td>
                        <td><button class="btn-delete" onclick="deleteTest(${test.id})">DELETE</button></td>
                    </tr>
                `;
            }).join('');
        }
        
        // --- Data Import/Export Functions (FIXED) ---

        function exportData() {
            const exportObject = { tests, tasks, studyLogs };
            const dataStr = JSON.stringify(exportObject, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `jee-tracker-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        
                        if (importedData.tests) { tests = importedData.tests; saveTests(); }
                        if (importedData.tasks) { tasks = importedData.tasks; saveTasks(); }
                        if (importedData.studyLogs) { studyLogs = importedData.studyLogs; saveStudyLogs(); } 
                        
                        renderCalendar();
                        updateUI();
                        
                        alert('Data imported successfully!');
                    } catch (error) {
                        alert('Error importing data. Please check the file format.');
                    }
                };
                reader.readAsText(file);
            }
        }

        // --- Calendar & Task Functions ---
        function loadTasks() {
            const savedTasks = localStorage.getItem('jee-tasks');
            if (savedTasks) {
                try { tasks = JSON.parse(savedTasks); } catch (e) { console.error('Error loading tasks:', e); tasks = {}; }
            }
        }
        function saveTasks() { localStorage.setItem('jee-tasks', JSON.stringify(tasks)); }
        
        function renderCalendar() {
            const today = new Date();
            const grid = document.getElementById('calendarGrid');
            const header = document.getElementById('currentMonthYear');
            
            // Remove old day elements, preserving the 7 day names
            while (grid.children.length > 7) { grid.removeChild(grid.lastChild); } 
            
            const monthNames = ["JANUARY", "FEBRUARY", "MARCH", "AIPRIL", "MAY", "JUNE", "JULY", "AUGUST", "SEPTEMBER", "OCTOBER", "NOVEMBER", "DECEMBER"];
            header.textContent = `${monthNames[currentMonth]} ${currentYear}`;
            const firstDayOfMonth = new Date(currentYear, currentMonth, 1).getDay(); 
            const daysInMonth = new Date(currentYear, currentMonth + 1, 0).getDate();
            
            // Fill in inactive days for spacing
            for (let i = 0; i < firstDayOfMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'inactive');
                dayDiv.textContent = ''; 
                grid.appendChild(dayDiv);
            }

            // Fill in actual days
            for (let i = 1; i <= daysInMonth; i++) {
                const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day');
                dayDiv.textContent = i;
                
                const dateStr = new Date(currentYear, currentMonth, i).toDateString();
                dayDiv.setAttribute('data-date', dateStr);
                dayDiv.onclick = () => selectDate(dateStr);
                
                if (i === today.getDate() && currentMonth === today.getMonth() && currentYear === today.getFullYear()) { dayDiv.classList.add('today'); }
                
                // Set the selected class after the elements are in the DOM
                if (dateStr === selectedDate.toDateString()) {
                    setTimeout(() => {
                        document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
                        dayDiv.classList.add('selected');
                    }, 0); 
                }

                if (tasks[dateStr] && tasks[dateStr].length > 0) {
                    const dot = document.createElement('span');
                    dot.classList.add('task-dot');
                    dayDiv.appendChild(dot);
                }
                grid.appendChild(dayDiv);
            }

            // Fill in remaining days of the last week
            const currentCells = grid.children.length;
            const cellsNeeded = 7 * Math.ceil((currentCells - 7) / 7 + 1);
            
            for (let i = currentCells; i < cellsNeeded; i++) {
                 const dayDiv = document.createElement('div');
                dayDiv.classList.add('calendar-day', 'inactive');
                dayDiv.textContent = ''; 
                grid.appendChild(dayDiv);
            }
        }
        
        function changeMonth(step) {
            currentMonth += step;
            if (currentMonth > 11) { currentMonth = 0; currentYear++; } else if (currentMonth < 0) { currentMonth = 11; currentYear--; }
            const newDate = new Date(currentYear, currentMonth, selectedDate.getDate());
            if (newDate.getMonth() !== currentMonth) { selectedDate = new Date(currentYear, currentMonth, 1); } else { selectedDate = newDate; }
            renderCalendar();
            selectDate(selectedDate.toDateString());
        }
        
        function selectDate(dateStr) {
            document.querySelectorAll('.calendar-day.selected').forEach(el => el.classList.remove('selected'));
            const newSelectedDayElement = document.querySelector(`.calendar-day[data-date="${dateStr}"]`);
            if(newSelectedDayElement) { newSelectedDayElement.classList.add('selected'); }
            
            selectedDate = new Date(dateStr);
            document.getElementById('selectedDateTitle').textContent = `TASKS FOR ${selectedDate.toLocaleDateString('en-GB', {weekday: 'short', day: 'numeric', month: 'long'}).toUpperCase()}`;
            renderTasks();
        }
        
        function renderTasks() {
            const taskList = document.getElementById('taskList');
            const dateKey = selectedDate.toDateString();
            const dailyTasks = tasks[dateKey] || [];
            
            if (dailyTasks.length === 0) {
                taskList.innerHTML = '<p class="empty-state" style="padding: 10px; margin-top: 10px; border-top: none;">NO TASKS FOR THIS DATE.</p>';
                return;
            }
            
            taskList.innerHTML = dailyTasks.map(task => `
                <div class="task-item" data-id="${task.id}">
                    <span>${task.text}</span>
                    <button class="btn-delete" onclick="deleteTask(${task.id})">REMOVE</button>
                </div>
            `).join('');

            // Apply slide-in animation to new items
            document.querySelectorAll('.task-item').forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, 50 * index);
            });
        }
        
        function addTask() {
            const taskInput = document.getElementById('taskInput');
            const taskText = taskInput.value.trim();
            const dateKey = selectedDate.toDateString();
            if (taskText) {
                if (!tasks[dateKey]) { tasks[dateKey] = []; }
                tasks[dateKey].push({ id: Date.now(), text: taskText });
                taskInput.value = '';
                saveTasks();
                renderTasks();
                renderCalendar(); 
            } else {
                alert('Please enter a task description.');
            }
        }
        
        function deleteTask(id) {
            const dateKey = selectedDate.toDateString();
            if (tasks[dateKey]) {
                const item = document.querySelector(`.task-item[data-id="${id}"]`);
                if (item) {
                    item.style.transform = 'translateX(100%)';
                    item.style.opacity = '0';
                    item.style.height = '0';
                    item.style.marginBottom = '0';
                    item.style.paddingTop = '0';
                    item.style.paddingBottom = '0';
                }
                
                setTimeout(() => {
                    tasks[dateKey] = tasks[dateKey].filter(task => task.id !== id);
                    if (tasks[dateKey].length === 0) { delete tasks[dateKey]; }
                    saveTasks();
                    renderTasks();
                    renderCalendar();
                }, 400); 
            }
        }
        
        // --- Study Log Functions ---

        function loadStudyLogs() {
            const savedLogs = localStorage.getItem('jee-study-logs');
            if (savedLogs) {
                try { studyLogs = JSON.parse(savedLogs); } catch (e) { console.error('Error loading study logs:', e); studyLogs = []; }
            }
        }

        function saveStudyLogs() {
            localStorage.setItem('jee-study-logs', JSON.stringify(studyLogs));
        }

        function parseTime(timeString) {
            const parts = timeString.split('-').map(s => s.trim());
            if (parts.length !== 2) return 0;

            const parseSingleTime = (t) => {
                const isPM = t.toUpperCase().includes('PM');
                t = t.replace(/(am|pm)/i, '').trim();
                let [h, m] = t.split(':').map(Number);
                if (isNaN(m) || isNaN(h)) {
                    h = Number(t); m = 0;
                    if (isNaN(h)) return 0;
                }
                
                if (isPM && h !== 12) h += 12;
                if (!isPM && h === 12) h = 0; 
                return h * 60 + m; // Total minutes
            };

            const startMinutes = parseSingleTime(parts[0]);
            let endMinutes = parseSingleTime(parts[1]);

            // Handle overnight sessions (e.g., 10 PM - 1 AM)
            if (endMinutes < startMinutes) {
                // If it's a day time to day time span (e.g., 1 AM to 2 AM), assume it's same day unless start is > end
                // If start is e.g., 23:00 (11 PM) and end is 01:00 (1 AM), end is smaller but it's the next day
                // The current logic works by converting to military time, so only if the minutes value of end is smaller than start, we add 24 hours.
                // The logic below is a simplified approximation and might need refinement for edge cases, but covers the general 12-hour span.
                // Reverting to simpler check: if end time is numerically less than start time in minutes, assume it's the next day.
                endMinutes += 24 * 60;
            }
            
            let durationMinutes = endMinutes - startMinutes;
            
            return durationMinutes / 60; // Duration in hours
        }

        function addStudyLog() {
            const date = document.getElementById('logDate').value;
            const time = document.getElementById('logTime').value.trim();
            const activity = document.getElementById('logActivity').value.trim();

            if (!date || !time || !activity) {
                alert('Please fill in all fields for the Study Log.');
                return;
            }
            
            const hours = parseTime(time);
            
            if (hours <= 0 || hours > 12) {
                alert('Could not calculate a positive duration from the time block. Please check the format (e.g., 10:00 AM - 1:00 PM) or ensure the duration is reasonable (max 12 hours).');
                return;
            }

            const log = { id: Date.now(), date, time, activity, hours };

            studyLogs.push(log);
            studyLogs.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort Reverse Chronologically (Newest first)
            saveStudyLogs();

            document.getElementById('logDate').value = '';
            document.getElementById('logTime').value = '';
            document.getElementById('logActivity').value = '';

            renderStudyLogs();
        }
        
        function deleteStudyLog(id) {
            if (confirm('Are you sure you want to delete this study session?')) {
                const item = document.querySelector(`.log-entry[data-id="${id}"]`);
                if (item) {
                    item.style.transform = 'translateX(100%)';
                    item.style.opacity = '0';
                    item.style.height = '0';
                    item.style.marginBottom = '0';
                    item.style.paddingTop = '0';
                    item.style.paddingBottom = '0';
                }
                
                setTimeout(() => {
                    studyLogs = studyLogs.filter(log => log.id !== id);
                    saveStudyLogs();
                    renderStudyLogs();
                }, 400); 
            }
        }

        function renderStudyLogs() {
            const listContainer = document.getElementById('studyLogList');
            const totalHoursSpan = document.getElementById('totalStudyHours');

            if (studyLogs.length === 0) {
                listContainer.innerHTML = '<p class="empty-state" style="padding: 10px; border-top: none;">NO STUDY SESSIONS LOGGED YET.</p>';
                totalHoursSpan.textContent = `TOTAL LOGGED: 0.0 HRS`;
                return;
            }

            const totalHours = studyLogs.reduce((sum, log) => sum + (log.hours || 0), 0);
            totalHoursSpan.textContent = `TOTAL LOGGED: ${totalHours.toFixed(1)} HRS`;
            
            listContainer.innerHTML = studyLogs.map(log => {
                const formattedDate = new Date(log.date).toLocaleDateString('en-GB');
                return `
                    <div class="log-entry" data-id="${log.id}">
                        <div class="log-details">
                            <div class="log-date-time">
                                <strong>${formattedDate}</strong> | 
                                <span class="log-time" style="color: var(--color-dark-subtext);">${log.time}</span> 
                            </div>
                            <div class="log-description" style="margin-top: 5px;">
                                ${log.activity} 
                            </div>
                        </div>
                        <div class="log-actions-wrapper">
                            <span class="log-hours">(${log.hours.toFixed(1)} HRS)</span>
                            <button class="btn-delete" onclick="deleteStudyLog(${log.id})">REMOVE</button>
                        </div>
                    </div>
                `;
            }).join('');
            
            // Apply slide-in animation to new log items
            document.querySelectorAll('#studyLogList .log-entry').forEach((item, index) => {
                setTimeout(() => {
                    item.style.opacity = '1';
                    item.style.transform = 'translateX(0)';
                }, 50 * index);
            });
        }
        
        // --- Stopwatch Functions ---

        function formatTime(ms) {
            const totalSeconds = Math.floor(ms / 1000);
            const hours = String(Math.floor(totalSeconds / 3600)).padStart(2, '0');
            const minutes = String(Math.floor((totalSeconds % 3600) / 60)).padStart(2, '0');
            const seconds = String(totalSeconds % 60).padStart(2, '0');
            return `${hours}:${minutes}:${seconds}`;
        }

        function updateStopwatchDisplay() {
            document.getElementById('stopwatchDisplay').textContent = formatTime(elapsedTime);
        }

        function startStopwatch() {
            const startStopBtn = document.getElementById('startStopBtn');
            const display = document.getElementById('stopwatchDisplay');

            if (!stopwatchRunning) {
                stopwatchRunning = true;
                startStopBtn.textContent = 'STOP';
                startStopBtn.classList.remove('start-btn-custom');
                startStopBtn.classList.add('stop-btn-custom');
                display.classList.add('running');

                const startTime = Date.now() - elapsedTime;
                stopwatchInterval = setInterval(() => {
                    elapsedTime = Date.now() - startTime;
                    updateStopwatchDisplay();
                }, 1000); 
            } else {
                stopwatchRunning = false;
                startStopBtn.textContent = 'START';
                startStopBtn.classList.remove('stop-btn-custom');
                startStopBtn.classList.add('start-btn-custom');
                display.classList.remove('running');
                clearInterval(stopwatchInterval);
            }
        }

        function resetStopwatch() {
            if (stopwatchRunning) {
                startStopwatch(); // Stop it first if running
            }
            elapsedTime = 0;
            updateStopwatchDisplay();
        }
    </script>
</body>
</html>
